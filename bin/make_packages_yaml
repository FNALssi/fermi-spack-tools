#!/bin/sh

case "x$0" in
x*/*) dir=`echo $0 | sed -e 's;\(.*\)/\([^/]*\);\1/..;'` ;;
x*)   dir=.. ;;
esac

os=${2:-`spack arch -o`}

src=$dir/templates/packagelist
optf=$dir/templates/package_opts
dst=$1/etc/spack/$os/packages.yaml

runversion() {
   # try to get version by running executable --version
   # in some cases this works due to error messages...
   $1 --version 2>&1 | 
      grep -i $1 | 
      head -1 | 
      grep -v 'command not found' |
      sed -e 's/^.*\([0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\).*$/\1/'
}

# define getv depending on platform 

case `uname -s` in
Linux)
: linux case
    case `lsb_release -i` in
    *Ubuntu)
        : ubuntu case
        getv() {
           apt list $1 2>/dev/null | grep '\[installed\]'| sed -e 's/[^ ]* //' -e 's/.*://' -e 's/[+-].*//'
        }
    ;;
    *Scientific*|*Centos*|*RedHat*)
        if [ x$RPMCACHE != x ]
        then
        getv() {
           grep "^$1-[0-9]" $RPMCACHE | tail -1 | grep -v 'is not installed' | sed -e 's/[^-]*-//' -e 's/[a-z][^-]*-//' -e 's/-.*//'
        }
        else
        getv() {
           rpm -q $1 | tail -1 | grep -v 'is not installed' | sed -e 's/[^-]*-//' -e 's/[a-z][^-]*-//' -e 's/-.*//'
        }
        fi
        ;;
    esac
;;
*)
    : generic / darwin case
    getv() {
       case x$1 in
       xautotools)
           runversion automake
           ;;
       xlibtool) 
           # looks like a library, but its not...
           runversion $1
           ;;
       xtcl)
           echo info patchlevel | tclsh
           ;;
       xlib*) 
           otool -L /usr/lib/$1 | grep "$1.*current version" |  sed -e 's/.*version//' -e 's/)//'
           ;;
       x*)
           runversion $1
           ;;
       esac
    }
    ;;
esac

mkdir -p `dirname $dst`

compiler=""
if [ "x`getv gcc`" != x ]
then
    compiler="gcc@`getv gcc`"
    comp="%$compiler"
else
    comp=""
fi

if [ "x`getv clang`" != x ]
then
    compiler="$compiler clang@`getv clang`"
fi

exec 3>$dst
echo "packages:" >&3

if [ "x$compiler" != x ]
then
    echo "  all:"                     >&3
    echo "    compiler: [$compiler]"  >&3
fi

for p in `cat $src`
do
    v=`getv $p`
    if [ "x$v" = x ]
    then
        # not found...
        continue
    fi
    opts=`grep "^$p\s" $optf | sed -e 's/.*\t//' -e 's/ *$//'`
    lp=`echo $p | tr '[A-Z]' '[a-z]' | sed -e 's/imagemagick/image-magick/' -e 's/^python-/py-/'`
    echo "  $lp:"                >&3
    echo "    paths:"           >&3
    echo "      $p@$v$opts$comp os=$os: /usr"    >&3
done
