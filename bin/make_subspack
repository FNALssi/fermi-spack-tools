#!/bin/sh

# make a sub-spack repository
# ...but make it unified layout...

src=$1
dst=$2


spackbindir=`echo $0 | sed -e 's;make_subspack;;' `
case x$spackbindir in
x/*) ;;
x*)  spackbindir="$PWD/$spackbindir"
esac


spack_release=rollout2

dst="$dst/spack/$spack_release/NULL/"

dstb=`basename $dst`
dstb=`dirname $dst`

mkdir -p $dstb
export SPACK_ROOT=$dst

for config_yaml in $src/etc/spack/default/config.yaml $src/etc/spack/config.yaml 
do
    if [ -r $config_yaml ]
    then
        install_tree_path=`grep install_tree: $config_yaml`
        install_tcl_path=`grep tcl: $config_yaml`
    fi
done
install_tree_path=${install_tree_path:-$src/opt/spack}
install_tcl_path=${install_tcl_path:-$src/share/spack/modules}

test -d $dstb || mkdir -p $dstb

cd $dstb
git clone https://cdcvs.fnal.gov/projects/spack-infrastructure-spack $dst

cp $spackbindir/../templates/config.yaml.unified $SPACK_ROOT/etc/spack/config.yaml
cd $dst
git checkout $spack_release

spackbindir=`echo $0 | sed -e 's;make_subspack;;'`
cp $spackbindir/../templates/config.yaml.unified etc/spack/config.yaml"

cat >> etc/spack/upstreams.yaml <<EOF

 upstreams:
    spack-instance-1:
      install_tree: $install_tree_path
      modules:
        tcl: $install_tcl_path
EOF

